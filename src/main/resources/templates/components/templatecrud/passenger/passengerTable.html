<div th:fragment="passengerTable" xmlns:th="http://www.w3.org/1999/xhtml">
    <h2 th:text="#{templateCRUD.transportsForPassengerTableTitle}" class="mt-2 mb-2"></h2>
    <th:block th:insert="~{components/templatecrud/passenger/showPassengerTablesEditIcons :: showPassengerIconsCheckbox}">  </th:block>

    <table class="table table-striped table-bordered shadow-lg w-100" id="passengerTransportsTable" cellspacing="0">
        <thead class="bg-light">

            <!-- Event Name row -->
            <tr>
                <th th:data-date="${templateYear} + '-' + ${monthNumber} + '-' + '00'" class="text-nowrap"></th>
                <th th:each="date: ${templateDates}" th:data-date="${date.transportDate}" th:text="${date.eventName}" class="text-nowrap"></th>
            </tr>

            <!-- Days of the week row -->
            <tr>
                <!-- empty for the passengers column -->
                <th th:data-date="${templateYear} + '-' + ${monthNumber} + '-' + '00'" class="text-nowrap"></th>
                <th th:each="date: ${templateDates}"
                    th:data-date="${date.transportDate}"
                    name="monthDate"
                    class="text-nowrap"
                >
                    <span th:text="${#messages.msgOrNull(date.dayOfTheWeekName) + ' ' + date.transportDate.toString().substring(8)}"></span>
                        <i class="fas fa-trash text-danger" role="button" data-name="date-delete-icon" data-passenger-showable-icon="data-passenger-showable-icon"
                           th:data-a="${(date.dateType == 'transportDate') ? date.id : ''}"
                           th:data-b="${(date.dateType == 'event') ? date.id : ''}"
                        ></i>
                </th>
            </tr>

        </thead>
        <tbody>
            <tr th:each="passenger : ${passengersFromTemplateList}" th:id="'passenger_row_' + ${passenger.id}" class="" >

                <!-- Passenger name -->
                <th th:id="'passengerNameCell_' + ${passenger.id}"
                    th:data-t="${passenger.id}"
                    th:data-date="${templateYear} + '-' + ${monthNumber} + '-' + '00'"
                    class="text-nowrap text-left"
                    style="cursor:move"
                    draggable="true"
                    data-draggable="involvedTable"
                >
                    <!-- Passenger buttons row -->
                    <div class="d-flex flex-column row">
                        <div class="col" data-passenger-showable-icon="data-passenger-showable-icon">

                            <!-- Communication icon -->
                            <div class="row">
                                <div class="col" th:id="'markAsCommunicatedPassegerButtonDiv_' + ${passenger.id}">
                                    <i class="fas fa-exclamation-circle text-danger"
                                       role="button"
                                       th:title="#{templateCRUD.titleMarkCommunicationStart} + ' ' + ${passenger.name} + ' ' + ${passenger.surname} + ' ' + #{templateCRUD.titleMarkAllCommunicationsEnd}"
                                       th:id="'markAsCommunicatedPassegerButton_' + ${passenger.id}"
                                    ></i>
                                </div>
                            </div>
                            <!-- Communication icon -->

                        </div>
                    </div>
                    <!-- Passenger buttons row -->

                    <!-- Passenger name row -->
                    <div class="row mt-1">
                        <div class="col">
                            <span
                                    th:text="${passenger.name} + ' ' + ${passenger.surname}"
                                    th:id="${passenger.id} + '_th_passenger_name_span'" >
                            </span>
                        </div>
                    </div>
                    <!-- Passenger name row -->
                </th>

                <!-- Assistance for date -->
                <td th:each="date : ${templateDates}" th:data-date="${date.transportDate}"
                    th:class="${((date.dateType == 'event') or (date.dateType == 'transportDate')
                        and (passengersAvailableForDate.get(date.id) == null)) ? 'text-center' : ''}"
                    th:id="'p' + ${passenger.id} + 't' + ${date.id} + '_date_td'"
                    th:data-t="${passenger.id}"
                    th:data-date-id="${date.id}"
                    th:data-y="'t' + ${date.id}"
                    th:data-tr-ref="'passenger_row_' + ${passenger.id}"
                    th:data-driver-selector="${'selectDriverForPassenger_' + passenger.id + '_' + date.id + '_select'}"
                    data-passenger-td="data-passenger-td"
                >
                    <!-- Event display -->
                    <span th:if="${(date.dateType == 'event')}">--------</span>
                    <!-- Event display -->

                    <!-- Transport Date display -->
                    <th:block th:if="${(date.dateType == 'transportDate')}"
                              th:with="passengerAssistance=${passengersAssistanceDates.get(passenger.id)}">

                        <div class="d-flex flex-column">

                            <!-- Div for buttons to change passenger status on current date -->
                            <div class="row h-25" data-passenger-showable-icon="data-passenger-showable-icon" th:id="${'passenger_icon_row_' + passenger.id}">

                                <!-- Needs Transport div (Show if passenger assists) -->
                                <div
                                    th:id="${'needsTransportIcon_' + passenger.id + '_' + date.id}"
                                    th:class="${((passengerAssistance != null) and
                                                    (passengerAssistance.get(date.transportDate.toLocalDate()) == null)) ?
                                                        'col-2 d-none' : 'col-2'}">

                                    <!-- Needs Transport icon -->
                                    <i
                                        th:data-t="${passenger.id}"
                                        th:data-y="${date.id}"
                                        th:data-passenger-select="${'selectDriverForPassenger_' + passenger.id + '_' + date.id}"
                                        th:data-needs-transport="${(passengerAssistance.get(date.transportDate.toLocalDate()) == null or
                                                passengerAssistance.get(date.transportDate.toLocalDate()).needsTransport == 1) ? 0 : 1}"
                                        th:class="'position-relative fas fa-car ' + ${(passengerAssistance.get(date.transportDate.toLocalDate()) == null or
                                                passengerAssistance.get(date.transportDate.toLocalDate()).needsTransport == 1) ?
                                                'text-primary' : 'text-muted'}"
                                        th:title="#{templateCRUD.titleCarIconNeedsTransportForDate}"
                                        role="button"
                                        style="top: 0; left: 0font-size: 1.5em;"
                                    ></i>
                                    <!-- Needs Transport icon -->
                                </div>
                                <!-- Needs Transport div (Show if passenger assists) -->

                                <!-- Assistance div -->
                                <div class="col-2">

                                    <!-- Assistance icon -->
                                    <i class="fas fa-calendar-check"
                                       th:data-t="${passenger.id}"
                                       th:data-y="${date.id}"
                                       th:data-passenger-select="${'selectDriverForPassenger_' + passenger.id + '_' + date.id}"
                                       th:data-passenger-assist="${(passengerAssistance.get(date.transportDate.toLocalDate()) == null) ? 0 : 1}"
                                       th:title="#{templateCRUD.titleCalendarIconPassengerAssistsOnTransportForDate}"
                                       role="button"
                                       th:class="${(passengerAssistance.get(date.transportDate.toLocalDate()) != null) ?
                                            'fas fa-calendar-check text-primary' : 'fas fa-calendar-check text-muted'}"
                                    ></i>
                                    <!-- Assistance icon -->
                                </div>
                                <!-- Assistance div -->

                                <!-- Communication icon div -->
                                <div class="col-2">
                                    <!-- Communication icon -->
                                    <i
                                            th:class="'fas fa-exclamation-circle ' +
                                                ${(passengerAssistance != null
                                                    and passengerAssistance.get(date.transportDate.toLocalDate()) != null
                                                    and passengerAssistance.get(date.transportDate.toLocalDate()).needsTransport == 0)
                                                    or (passengerAssistance == null or passengerAssistance.get(date.transportDate.toLocalDate()) == null) ?
                                                        'd-none' :
                                                            (
                                                                involvedCommunications.get(date.id) != null
                                                                and involvedCommunications.get(date.id).get(passenger.id) != null
                                                                and involvedCommunications.get(date.id).get(passenger.id) == true ?
                                                                    'text-muted' : 'text-danger'
                                                            )}"
                                        role="button"
                                        th:title="#{templateCRUD.titleMarkCommunicationStart} + ' ' + ${passenger.name} + ' ' + ${passenger.surname} + ' ' + #{templateCRUD.titleMarkCommunicationEnd} + ' ' + ${date.transportDate}"
                                        th:data-drivers-selector="${'selectDriverForPassenger_' + passenger.id + '_' + date.id + '_select'}"
                                        th:data-passenger-th="'passengerNameCell_' + ${passenger.id}"
                                        th:data-date-td="'p' + ${passenger.id} + 't' + ${date.id} + '_date_td'"
                                    ></i>
                                    <!-- Communication icon -->
                                </div>
                                <!-- Communication icon div -->

                            </div>
                            <!-- Div for buttons to change passenger status on current date -->

                            <!-- Div for transport info -->
                            <div class="d-table-cell row h-75 mt-2 d-flex justify-content-center align-items-center">
                                <div class="col">
                                    <!-- Drivers select -->
                                    <!-- show only if passenger needs transport -->
                                    <select name="driverInTransportSelect"
                                            th:aria-label="${passenger.name} + ' ' + ${passenger.surname} + ': ' + #{templateCRUD.driverFor} + ' ' + ${date.dayOfTheWeekName} + ' ' + ${date.transportDate}"
                                            class="bg-transparent border border-0"
                                            th:data-t="${passenger.id}"
                                            th:id="${'selectDriverForPassenger_' + passenger.id + '_' + date.id + '_select'}"
                                            th:class="${((passengerAssistance != null)
                                                    and (passengerAssistance.get(date.transportDate.toLocalDate()) != null)
                                                    and (passengerAssistance.get(date.transportDate.toLocalDate()).needsTransport == 1)) ?
                                                        'bg-transparent border border-0 w-100' : 'bg-transparent border border-0 w-100 d-none'}">

                                        <!-- option for deleting the transport -->
                                        <option selected="selected" name="d" th:data-d="${date.id}" th:data-t="${passenger.id}"></option>

                                        <!-- driver options-->
                                        <option
                                                th:each="driver : ${driversAvailableForDate.get(date.id)}"
                                                th:selected="${(allPassengerTransportsFromTemplate.get(passenger.id).get(date.id) != null)
                                                            and (driver.id == allPassengerTransportsFromTemplate.get(passenger.id).get(date.id).getTransportKey().driverId)
                                                            and (passenger.id == allPassengerTransportsFromTemplate.get(passenger.id).get(date.id).getTransportKey().passengerId)}"
                                                th:text="${driver.name}"
                                                th:value="${driver.id}"
                                                th:data-d="${date.id}"
                                                th:data-t="${passenger.id}"
                                                th:data-passenger-name="${passenger.name} + ' ' + ${passenger.surname}"
                                                th:name="${allPassengerTransportsFromTemplate.get(passenger.id).get(date.id) == null}? 'c' : 'u'"
                                        ></option>
                                    </select>

                                    <!-- 'Does not need transport' Span -->
                                    <!-- If passenger does not need transport -->
                                    <span th:id="${'selectDriverForPassenger_' + passenger.id + '_' + date.id + '_doesNotNeedTransportSpan'}"
                                            th:class="${((passengerAssistance != null)
                                                    and (passengerAssistance.get(date.transportDate.toLocalDate()) != null)
                                                    and (passengerAssistance.get(date.transportDate.toLocalDate()).needsTransport == 0)) ?
                                                    ' ' : 'd-none'}"
                                          th:text="#{templateCRUD.doesNotNeedTransporte}"></span>

                                    <!-- 'Does not asist' Span -->
                                    <!-- If passenger does not assist on this date -->
                                    <span th:id="${'selectDriverForPassenger_' + passenger.id + '_' + date.id + '_doesNotAssistSpan'}"
                                            th:class="${((passengerAssistance != null)
                                                    and (passengerAssistance.get(date.transportDate.toLocalDate()) == null))?
                                                    ' ' : 'd-none'}"
                                          th:text="#{templateCRUD.doesNotAssist}"></span>
                                </div>

                            </div>
                            <!-- Div for transport info -->

                        </div>
                    </th:block>
                    <!-- Transport Date display -->
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script src="/js/own/templatecrud/passenger/TemplateCrudPassengerCommunications.js" type="module"></script>
<script src="/js/own/templatecrud/passenger/TemplateCrudPassengerAvailabilityForDateCRUD.js" type="module"></script>